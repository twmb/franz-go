name: lint and test

on:
  push:
    branches: ["master"]
    paths-ignore:
      - '**/*.md'
  pull_request:
    branches: ["*"]
    paths-ignore:
      - '**/*.md'

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  golangci-root:
    if: github.repository == 'twmb/franz-go'
    runs-on: ubuntu-latest
    name: "golangci-lint-root on amd64"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: 'stable'
      - uses: golangci/golangci-lint-action@v7
        with:
          version: latest
          args: --timeout=5m

  golangci-kadm:
    if: github.repository == 'twmb/franz-go'
    runs-on: ubuntu-latest
    name: "golangci-lint-kadm on amd64"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: 'stable'
      - uses: golangci/golangci-lint-action@v7
        with:
          working-directory: pkg/kadm
          version: latest
          args: --timeout=5m

  test-kfake:
    if: github.repository == 'twmb/franz-go'
    runs-on: ubuntu-latest
    name: "test kfake"
    container: golang:latest
    steps:
      - uses: actions/checkout@v4
      - run: cd pkg/kfake && go work init . ../.. ../kadm ../kmsg && go test ./... && go test -race ./...

  test-sr:
    if: github.repository == 'twmb/franz-go'
    runs-on: ubuntu-latest
    name: "test sr"
    container: golang:latest
    steps:
      - uses: actions/checkout@v4
      - run: cd pkg/sr && go work init ../.. . && go test .

  integration-test-kfake:
    if: github.repository == 'twmb/franz-go'
    runs-on: ubuntu-latest
    name: "integration test kfake ${{ matrix.version }}"
    container: golang:latest
    strategy:
      matrix:
        version: ["0.11.0", "1.1", "2.8", "3.9", "4.1"]
    steps:
      - uses: actions/checkout@v4
      - name: Start kfake and run tests
        run: |
          (cd pkg/kfake && go work init . ../.. ../kadm ../kmsg && go run main.go --as-version ${{ matrix.version }} -c group.consumer.heartbeat.interval.ms=1000 -l debug) > /tmp/kfake.log 2>&1 &
          sleep 2
          go test -timeout 5m ./...
        env:
          KGO_TEST_RF: 1
          KGO_SEEDS: 127.0.0.1:9092
      - name: Upload kfake logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: kfake-logs-${{ matrix.version }}
          path: /tmp/kfake.log

  integration-test-kafka:
    if: github.repository == 'twmb/franz-go'
    runs-on: ubuntu-latest
    name: "integration test kafka"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: 'stable'
      - name: Create Kafka configuration files
        run: |
          mkdir -p kafka-config
          cat > kafka-config/jaas.conf << 'EOF'
          KafkaServer {
              org.apache.kafka.common.security.scram.ScramLoginModule required;
          };
          EOF
          cat > docker-compose.yml << 'EOF'
          services:
            kafka:
              image: apache/kafka:latest
              hostname: kafka
              ports:
                - "9092:9092"
                - "9094:9094"
              environment:
                KAFKA_NODE_ID: 1
                CLUSTER_ID: MkU3OEVBNTcwNTJENDM1Tk
                KAFKA_PROCESS_ROLES: controller,broker
                KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
                KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093,SASL_PLAINTEXT://:9094
                KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,SASL_PLAINTEXT:SASL_PLAINTEXT
                KAFKA_CONTROLLER_QUORUM_VOTERS: 1@localhost:9093
                KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://127.0.0.1:9092,SASL_PLAINTEXT://127.0.0.1:9094
                KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
                KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
                KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
                KAFKA_GROUP_COORDINATOR_REBALANCE_PROTOCOLS: classic,consumer
                KAFKA_SASL_ENABLED_MECHANISMS: SCRAM-SHA-256
                KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/jaas.conf"
              volumes:
                - ./kafka-config/jaas.conf:/etc/kafka/jaas.conf:ro
              healthcheck:
                test: ["CMD", "/opt/kafka/bin/kafka-broker-api-versions.sh", "--bootstrap-server", "localhost:9092"]
                interval: 5s
                timeout: 5s
                retries: 20
          EOF
      - name: Start Kafka
        run: docker compose up -d --wait
      - name: Create SCRAM user
        run: |
          docker compose exec -T kafka /opt/kafka/bin/kafka-configs.sh \
            --bootstrap-server localhost:9092 \
            --alter --add-config 'SCRAM-SHA-256=[iterations=4096,password=testpass]' \
            --entity-type users --entity-name testuser
      - run: go test -timeout 5m ./...
        env:
          KGO_TEST_RF: 1
          KGO_SEEDS: 127.0.0.1:9092
          KGO_TEST_STABLE_FETCH: true
          KGO_TEST_SCRAM_SEEDS: 127.0.0.1:9094
          KGO_TEST_SCRAM: testuser:testpass
      - name: Cleanup
        if: always()
        run: docker compose down -v

  integration-test-kafka-38:
    if: github.repository == 'twmb/franz-go'
    runs-on: ubuntu-latest
    name: "integration test kafka 3.8"
    container: golang:latest
    services:
      zookeeper:
        image: bitnamilegacy/zookeeper:latest
        ports:
          - 2181:2181
        env:
          ALLOW_ANONYMOUS_LOGIN: yes
      kafka:
        image: bitnamilegacy/kafka:3.8
        ports:
          - 9092:9092
        env:
          KAFKA_BROKER_ID: 1
          KAFKA_CFG_ZOOKEEPER_CONNECT: zookeeper:2181
          KAFKA_CFG_LISTENERS: PLAINTEXT://:9092
          KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
          ALLOW_PLAINTEXT_LISTENER: yes
    steps:
      - uses: actions/checkout@v4
      - run: go test -timeout 5m ./...
        env:
          KGO_TEST_RF: 1
          KGO_SEEDS: kafka:9092
          KGO_TEST_STABLE_FETCH: true

  integration-test-redpanda:
    if: github.repository == 'twmb/franz-go'
    runs-on: ubuntu-latest
    name: "integration test redpanda"
    container: golang:latest
    services:
      redpanda:
        image: redpandadata/redpanda
        ports:
          - 9092:9092
        env:
          REDPANDA_ADVERTISE_KAFKA_ADDRESS: redpanda:9092
    steps:
      - uses: actions/checkout@v4
      - run: go test -timeout 5m ./...
        env:
          KGO_TEST_RF: 1
          KGO_SEEDS: redpanda:9092
